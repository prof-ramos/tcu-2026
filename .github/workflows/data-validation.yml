name: ğŸ” Data Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'data/**'
      - 'scripts/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'data/**'
      - 'scripts/**'
  workflow_dispatch:

jobs:
  validate-data:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.8, 3.9, '3.10', '3.11']

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}

    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r scripts/requirements.txt
        pip install pytest pandas-profiling

    - name: ğŸ§ª Validate data integrity
      run: |
        python -c "
        import pandas as pd
        import sys
        
        print('ğŸ” Validando integridade dos dados...')
        
        # Carregar dados processados
        try:
            df = pd.read_csv('data/processed/db-questoes-limpo.csv')
            print(f'âœ… Dados carregados: {len(df)} registros')
        except Exception as e:
            print(f'âŒ Erro ao carregar dados: {e}')
            sys.exit(1)
        
        # ValidaÃ§Ãµes bÃ¡sicas
        errors = []
        
        # 1. Verificar se nÃ£o hÃ¡ valores nulos
        null_count = df.isnull().sum().sum()
        if null_count > 0:
            errors.append(f'âŒ Encontrados {null_count} valores nulos')
        else:
            print('âœ… Nenhum valor nulo encontrado')
        
        # 2. Verificar colunas esperadas
        expected_cols = ['hierarquia', 'topico', 'quantidade_encontrada', 'porcentagem_encontrada', 
                        'quantidade_caderno', 'porcentagem_caderno', 'porcentagem_encontrada_num', 
                        'porcentagem_caderno_num', 'nivel_hierarquia']
        missing_cols = set(expected_cols) - set(df.columns)
        if missing_cols:
            errors.append(f'âŒ Colunas faltando: {missing_cols}')
        else:
            print('âœ… Todas as colunas esperadas presentes')
        
        # 3. Verificar tipos de dados
        if df['quantidade_encontrada'].dtype not in ['int64', 'int32']:
            errors.append('âŒ Coluna quantidade_encontrada deve ser numÃ©rica')
        else:
            print('âœ… Tipos de dados corretos')
        
        # 4. Verificar ranges de porcentagem
        pct_out_of_range = ((df['porcentagem_encontrada_num'] < 0) | (df['porcentagem_encontrada_num'] > 100)).sum()
        if pct_out_of_range > 0:
            errors.append(f'âŒ {pct_out_of_range} porcentagens fora do range 0-100')
        else:
            print('âœ… Porcentagens dentro do range vÃ¡lido')
        
        # 5. Verificar consistÃªncia de totais
        total_encontrada = df['quantidade_encontrada'].sum()
        total_caderno = df['quantidade_caderno'].sum()
        diff = abs(total_encontrada - total_caderno)
        if diff > 10:  # TolerÃ¢ncia de 10 questÃµes
            errors.append(f'âŒ DiferenÃ§a muito grande entre totais: {diff}')
        else:
            print(f'âœ… Totais consistentes (diferenÃ§a: {diff})')
        
        # RelatÃ³rio final
        if errors:
            print('\\nâŒ VALIDAÃ‡ÃƒO FALHOU:')
            for error in errors:
                print(error)
            sys.exit(1)
        else:
            print('\\nğŸ‰ VALIDAÃ‡ÃƒO PASSOU! Dados Ã­ntegros e consistentes.')
            print(f'ğŸ“Š Resumo: {len(df)} registros, {df[\"topico\"].nunique()} tÃ³picos Ãºnicos')
        "

    - name: ğŸ” Test data loading script
      run: |
        cd scripts
        python -c "
        import clean_data
        print('âœ… Script de limpeza importado com sucesso')
        "

    - name: ğŸ“Š Generate data summary
      if: matrix.python-version == '3.11'
      run: |
        python -c "
        import pandas as pd
        
        df = pd.read_csv('data/processed/db-questoes-limpo.csv')
        
        print('\\nğŸ“Š RESUMO DOS DADOS:')
        print(f'Total de registros: {len(df):,}')
        print(f'Total de questÃµes: {df[\"quantidade_encontrada\"].sum():,}')
        print(f'TÃ³picos Ãºnicos: {df[\"topico\"].nunique():,}')
        print(f'NÃ­veis hierÃ¡rquicos: {df[\"nivel_hierarquia\"].nunique()}')
        
        print('\\nğŸ“š TOP 5 DISCIPLINAS:')
        top_disciplines = df[df['nivel_hierarquia'] == 0].nlargest(5, 'quantidade_encontrada')
        for _, row in top_disciplines.iterrows():
            print(f'  {row[\"topico\"]}: {row[\"quantidade_encontrada\"]:,} questÃµes ({row[\"porcentagem_encontrada\"]})')
        
        print('\\nğŸ“ˆ DISTRIBUIÃ‡ÃƒO HIERÃRQUICA:')
        hierarchy_dist = df['nivel_hierarquia'].value_counts().sort_index()
        for level, count in hierarchy_dist.items():
            print(f'  NÃ­vel {level}: {count:,} registros')
        "

    - name: âœ… Success notification
      if: success()
      run: |
        echo "ğŸ‰ ValidaÃ§Ã£o de dados concluÃ­da com sucesso!"
        echo "âœ… Dados Ã­ntegros e prontos para uso"